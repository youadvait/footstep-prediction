name: Build Windows VST3
on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Configure CMake
      run: |
        Write-Host "=== CMAKE CONFIGURATION ==="
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
    
    - name: Build VST3
      run: |
        Write-Host "=== BUILDING VST3 ==="
        cmake --build build --config Release --target FootstepDetector_VST3 --verbose
    
    - name: Find VST3 output
      run: |
        Write-Host "=== SEARCHING FOR BUILT VST3 ==="
        Get-ChildItem -Recurse build/ -Name "*.vst3" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found VST3: $_" }
        Get-ChildItem -Recurse build/ -Name "*FootstepDetector*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $_" }
    
    - name: Package VST3
      run: |
        Write-Host "=== PACKAGING VST3 ==="
        New-Item -ItemType Directory -Force -Path package
        
        # Look for VST3 in common build locations
        $vst3Paths = @(
          "build/FootstepDetector_artefacts/Release/VST3/FootstepDetector.vst3",
          "build/Release/VST3/FootstepDetector.vst3",
          "build/VST3/FootstepDetector.vst3"
        )
        
        $found = $false
        foreach ($path in $vst3Paths) {
          if (Test-Path $path) {
            Write-Host "✅ Found VST3 at: $path"
            Copy-Item -Recurse $path package/
            $found = $true
            break
          }
        }
        
        if (-not $found) {
          Write-Host "❌ VST3 not found in expected locations"
          Write-Host "All build outputs:"
          Get-ChildItem -Recurse build/ -Name "*.*" | Sort-Object | ForEach-Object { Write-Host "  $_" }
          
          # Create placeholder for debugging
          New-Item -Path "package/BUILD_COMPLETED_BUT_VST3_NOT_FOUND.txt" -Value "Build completed but VST3 location unknown" -Force
        }
        
    - name: Upload Windows VST3
      uses: actions/upload-artifact@v4
      with:
        name: FootstepDetector-Windows-VST3
        path: package/
        retention-days: 30
        
    - name: Upload build logs (for debugging)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Windows-Build-Logs
        path: |
          build/CMakeFiles/CMakeError.log
          build/CMakeFiles/CMakeOutput.log
        retention-days: 7
