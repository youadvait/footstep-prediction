name: Build Windows VST3

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download JUCE Framework
      run: |
        Write-Host "Downloading JUCE 7.0.12..."
        Invoke-WebRequest -Uri "https://github.com/juce-framework/JUCE/archive/refs/tags/7.0.12.zip" -OutFile "juce.zip"
        Expand-Archive juce.zip -DestinationPath .
        Move-Item JUCE-7.0.12 JUCE -Force
        Write-Host "JUCE downloaded and extracted"
        
    - name: Verify JUCE installation
      run: |
        if (Test-Path "JUCE\extras\Build\CMake\JUCEModuleSupport.cmake") {
          Write-Host "✅ JUCEModuleSupport.cmake found"
        } else {
          Write-Host "❌ JUCEModuleSupport.cmake missing"
          exit 1
        }
        dir JUCE\extras\Build\CMake\ | Select-Object -First 5
        
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup CMake
      uses: lukka/get-cmake@latest
      
    - name: Configure CMake (Windows x64)
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
        
    - name: Build VST3 Plugin
      run: |
        cmake --build build --config Release --target FootstepDetector_VST3 --parallel 4
        
    - name: Verify Build Output
      run: |
        if (Test-Path "build\FootstepDetector_artefacts\Release\VST3\FootstepDetector.vst3") {
          Write-Host "✅ VST3 plugin built successfully"
          dir build\FootstepDetector_artefacts\Release\VST3\
        } else {
          Write-Host "❌ VST3 plugin build failed"
          Get-ChildItem build -Recurse -Name "*.vst3"
          exit 1
        }
        
    - name: Upload Windows VST3 Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FootstepDetector-Windows-x64-VST3
        path: build/FootstepDetector_artefacts/Release/VST3/FootstepDetector.vst3
        
    - name: Create Release Package
      run: |
        mkdir FootstepDetector_Windows_Release
        robocopy build\FootstepDetector_artefacts\Release\VST3\FootstepDetector.vst3 FootstepDetector_Windows_Release\FootstepDetector.vst3 /E
        if ($LASTEXITCODE -le 7) { $LASTEXITCODE = 0 }
        echo "FootstepDetector VST3 Plugin - Installation Instructions" > FootstepDetector_Windows_Release\README.txt
        echo "" >> FootstepDetector_Windows_Release\README.txt
        echo "1. Copy the FootstepDetector.vst3 folder to:" >> FootstepDetector_Windows_Release\README.txt
        echo "   C:\Program Files\Common Files\VST3\" >> FootstepDetector_Windows_Release\README.txt
        echo "" >> FootstepDetector_Windows_Release\README.txt
        echo "2. Restart your DAW (Digital Audio Workstation)" >> FootstepDetector_Windows_Release\README.txt
        echo "" >> FootstepDetector_Windows_Release\README.txt
        echo "3. The plugin will appear as:" >> FootstepDetector_Windows_Release\README.txt
        echo "   FootstepTech -> FootstepDetector" >> FootstepDetector_Windows_Release\README.txt
        echo "" >> FootstepDetector_Windows_Release\README.txt
        echo "4. Plugin Controls:" >> FootstepDetector_Windows_Release\README.txt
        echo "   - Sensitivity: 0-100%% (footstep detection threshold)" >> FootstepDetector_Windows_Release\README.txt
        echo "   - Gain: 1-8x (amplification amount)" >> FootstepDetector_Windows_Release\README.txt
        echo "   - Bypass: On/Off (enable/disable processing)" >> FootstepDetector_Windows_Release\README.txt
        echo "" >> FootstepDetector_Windows_Release\README.txt
        echo "5. Compatible with:" >> FootstepDetector_Windows_Release\README.txt
        echo "   - FL Studio, Ableton Live, Reaper, Studio One" >> FootstepDetector_Windows_Release\README.txt
        echo "   - Any DAW that supports VST3 plugins" >> FootstepDetector_Windows_Release\README.txt
        echo "" >> FootstepDetector_Windows_Release\README.txt
        echo "6. For gaming: Use with audio routing software to process game audio" >> FootstepDetector_Windows_Release\README.txt
        echo "" >> FootstepDetector_Windows_Release\README.txt
        echo "Technical Details:" >> FootstepDetector_Windows_Release\README.txt
        echo "- Windows x64 compatible" >> FootstepDetector_Windows_Release\README.txt
        echo "- Multi-band footstep enhancement" >> FootstepDetector_Windows_Release\README.txt
        echo "- Professional audio processing" >> FootstepDetector_Windows_Release\README.txt
        echo "- Zero latency" >> FootstepDetector_Windows_Release\README.txt
        
    - name: Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: FootstepDetector-Windows-Complete
        path: FootstepDetector_Windows_Release/