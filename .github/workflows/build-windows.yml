name: Build Windows VST3
on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check JUCE version and functions
      run: |
        Write-Host "=== JUCE VERSION CHECK ==="
        if (Test-Path "JUCE/VERSION.txt") {
          Get-Content "JUCE/VERSION.txt"
        } else {
          Write-Host "No VERSION.txt found"
        }
        
        Write-Host "=== JUCE CMAKE FUNCTIONS ==="
        Select-String -Path "JUCE/CMakeLists.txt" -Pattern "juce_add_plugin|juce_generate_juce_header" | Select-Object -First 10
        
        Write-Host "=== SOURCE FILE CHECK ==="
        if (Test-Path "vst_plugin/Source/PluginProcessor.cpp") {
          Write-Host "PluginProcessor.cpp size: $((Get-Item 'vst_plugin/Source/PluginProcessor.cpp').Length) bytes"
          Write-Host "First 10 lines:"
          Get-Content "vst_plugin/Source/PluginProcessor.cpp" -TotalCount 10
        }
        
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: CMAKE DEBUG - Step by step
      run: |
        Write-Host "=== CMAKE STEP-BY-STEP DEBUG ==="
        Write-Host "Step 1: CMake version"
        cmake --version
        
        Write-Host "Step 2: Test basic CMake"
        cmake --help | Select-Object -First 5
        
        Write-Host "Step 3: Test generator"
        cmake -G "Visual Studio 17 2022" --help | Select-Object -First 5
        
        Write-Host "Step 4: Check JUCE subdirectory"
        if (Test-Path "JUCE/CMakeLists.txt") {
          Write-Host "âœ… JUCE CMakeLists.txt exists"
          Write-Host "JUCE CMakeLists.txt first 20 lines:"
          Get-Content "JUCE/CMakeLists.txt" -TotalCount 20
        }
        
        Write-Host "Step 5: Test basic CMake configuration"
        Write-Host "About to run: cmake -B build-test --debug-output -G ""Visual Studio 17 2022"" -A x64"
        
    - name: CMake Configure with MAXIMUM debug
      run: |
        Write-Host "=== FULL CMAKE CONFIGURE ==="
        $env:VERBOSE = "1"
        cmake -B build --debug-output --trace --trace-expand -G "Visual Studio 17 2022" -A x64 2>&1 | Tee-Object -FilePath cmake_full_debug.log
        Write-Host "CMAKE Exit Code: $LASTEXITCODE"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "=== CMAKE FAILED - Last 50 lines of output ==="
          Get-Content cmake_full_debug.log -Tail 50
        }
      shell: powershell
      continue-on-error: true
        
    - name: Upload ALL debug info
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Windows-Debug-Complete
        path: |
          cmake_full_debug.log
          build/CMakeFiles/CMakeError.log
          build/CMakeFiles/CMakeOutput.log
        retention-days: 7
